#!/usr/bin/env bash

# OS detection helper
function isMac {
  [[ "$OSTYPE" == "darwin"* ]]
}

function isLinux {
  [[ "$OSTYPE" == "linux-gnu"* ]]
}

function acceptXcodeLicense {
  if ! isMac; then
    echo "Skipping Xcode license (macOS only)"
    return 0
  fi

  echo "Xcode License"
  sudo xcodebuild -license
}

function getLatestBrew {
	echo "Installing latest homebrew"
	which brew || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

	# Detect brew installation path (different on Mac vs Linux)
	if [ -x /opt/homebrew/bin/brew ]; then
		BREW_PREFIX="/opt/homebrew"
	elif [ -x /usr/local/bin/brew ]; then
		BREW_PREFIX="/usr/local"
	elif [ -x /home/linuxbrew/.linuxbrew/bin/brew ]; then
		BREW_PREFIX="/home/linuxbrew/.linuxbrew"
	else
		echo "Could not find brew installation"
		return 1
	fi

	echo "eval \"\$(${BREW_PREFIX}/bin/brew shellenv)\"" >> ~/.zprofile
	eval "$(${BREW_PREFIX}/bin/brew shellenv)"

	brew update
	brew tap 'homebrew/bundle'
}

function brewInstall {
	echo "Installing brews"
	(cd brew && (brew bundle check || brew bundle install))
}

function stowDotfiles {
	echo "Stowing dotfiles"
	ls -d */ | sed 's/\///' | awk {'system("echo " $0); system("stow " $0)'}
}

function mackupRestore {
	if ! isMac; then
		echo "Skipping mackup restore (macOS only)"
		return 0
	fi

	echo "Restoring mackup - ensure mackup storage exists"
	MACKUP_DIR=$HOME/Dropbox/Mackup
	if [ ! -d $MACKUP_DIR ]; then
		echo "Mackup storage doesn't exists. exiting." && exit 1
	fi
	mackup restore
}

function initFish {
  FISH_PATH=$(brew --prefix)/bin/fish
  sudo echo "$FISH_PATH" >> /etc/shells
  chsh -s "$FISH_PATH"
  curl https://git.io/fisher --create-dirs -sLo ~/.config/fish/functions/fisher.fish
  source
  fisher
}

function initAsdf {
	echo "Installing asdf plugins"
	export GNUPGHOME="${ASDF_DIR:-$HOME/.asdf}/keyrings/nodejs" && mkdir -p "$GNUPGHOME" && chmod 0700 "$GNUPGHOME"
	brew install coreutils
	(cd asdf && (cat .tool-versions | awk '{system ("asdf plugin-add " $1)}'))
	bash ~/.asdf/plugins/nodejs/bin/import-release-team-keyring
	(cd asdf && (cat .tool-versions | awk '{system("asdf install " $0)}'))
}

function makeDirs {
	mkdir -p ~/Dev/src
}

function installTmuxPluginManager {
  git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
}

function installNix {
  echo "Installing Nix package manager"

  if command -v nix &> /dev/null; then
    echo "Nix is already installed"
    nix --version
    return 0
  fi

  echo "Downloading and installing Nix..."
  curl -L https://nixos.org/nix/install | sh

  echo "Sourcing Nix environment"
  if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
    . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
  fi

  echo "Nix installation complete"
  nix --version
}

function installNixDirenv {
  echo "Installing nix-direnv"

  if [ ! -f "$HOME/.nix-profile/share/nix-direnv/direnvrc" ]; then
    echo "Installing nix-direnv via Nix..."
    nix-env -iA nixpkgs.nix-direnv
    echo "nix-direnv installed successfully"
  else
    echo "nix-direnv is already installed"
  fi

  echo "Verifying nix-direnv installation..."
  if [ -f "$HOME/.nix-profile/share/nix-direnv/direnvrc" ]; then
    echo "✓ nix-direnv found at: $HOME/.nix-profile/share/nix-direnv/direnvrc"
  else
    echo "⚠️  Warning: nix-direnv not found after installation"
  fi
}

function setMacPreferences {
  if ! isMac; then
    echo "Skipping Mac preferences (macOS only)"
    return 0
  fi

  echo "Setting Mac preferences"

  # Auto hide dock
  defaults write com.apple.dock autohide -bool true
  defaults write com.apple.dock autohide-time-modifier -float 0.5
  defaults write com.apple.dock autohide-delay -float 0

  # Faster key repeat
  defaults write NSGlobalDomain KeyRepeat -int 2
  defaults write NSGlobalDomain InitialKeyRepeat -int 15

  # Disable hold key for accent
  defaults write -g ApplePressAndHoldEnabled -bool false

  # Trackpad
  defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool false
  defaults write NSGlobalDomain com.apple.swipescrolldirection -bool false
  
  # Mouse
  defaults write -g com.apple.mouse.scaling -float 1.5

  # Use Fn as function keys
  defaults write -g com.apple.keyboard.fnState -bool true

  # Full keyboard access
  defaults write -g AppleKeyboardUIMode -int 2
  
  # Show all extensions
  defaults write NSGlobalDomain AppleShowAllExtensions -bool true
  defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false
  defaults write com.apple.finder FXEnableRemoveFromICloudDriveWarning -bool false

  # Prefer list view in Finder
  defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"
  # Show path bar in Finder
  defaults write com.apple.finder ShowPathbar -bool true

  # Disable dashboard
  defaults write com.apple.dashboard mcx-disabled -bool true

  for app in "Dock" "Finder"; do
    killall "${app}" > /dev/null 2>&1
  done
}

# Bootstrap order for new machine setup:
#
# Cross-platform setup (works on macOS and Linux):
# 1. getLatestBrew            # Install Homebrew
# 2. brewInstall              # Install packages from Brewfile (auto-detects OS)
# 3. stowDotfiles             # Symlink dotfiles
# 4. installNix               # Install Nix package manager
# 5. installNixDirenv         # Install nix-direnv for better caching
# 6. initFish                 # Set fish as default shell
# 7. initAsdf                 # Install asdf plugins and versions
# 8. makeDirs                 # Create ~/Dev/src directory
# 9. installTmuxPluginManager # Install tpm
#
# macOS-only setup (automatically skipped on Linux):
# 10. acceptXcodeLicense      # Accept Xcode license (macOS only)
# 11. mackupRestore           # Restore app configs via Dropbox (macOS only)
# 12. setMacPreferences       # Apply macOS system settings (macOS only)
#
# Example usage:
#   ./up                      # No automatic execution - call functions manually
#
#   # On both macOS and Linux:
#   getLatestBrew
#   brewInstall
#   stowDotfiles
#   installNix
#   installNixDirenv
#   initFish
#   initAsdf
#   makeDirs
#   installTmuxPluginManager
#
#   # On macOS only (safe to run on Linux, will skip automatically):
#   acceptXcodeLicense
#   mackupRestore
#   setMacPreferences
