#!/usr/bin/env bash

function getLatestBrew {
	echo "Installing latest homebrew"
	which brew || /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

	brew update
	brew tap 'homebrew/bundle'
}

function brewInstall {
	echo "Installing brews"
	(cd brew && (brew bundle check || brew bundle install))
}

function stowDotfiles {
	echo "Stowing dotfiles"
	ls -d */ | sed 's/\///' | awk {'system("echo " $0); system("stow " $0)'}
}

function mackupRestore {
	echo "Restoring mackup - ensure mackup storage exists"
	MACKUP_DIR=$HOME/Dropbox/Mackup
	if [ ! -d $MACKUP_DIR ]; then
		echo "Mackup storage doesn't exists. exiting." && exit 1	
	fi
	mackup restore
}

function initFish {
        fisher
}
function installAsdf {
	git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.6.3
}

function initAsdf {
	echo "Installing asdf plugins"
	(cd asdf && (cat .tool-versions | awk '{system ("asdf plugin-add " $1); system("asdf install " $0)}'))
}

function asdfInstallNode {
	echo "Installing node via asdf"
	brew install coreutils
	brew install gpg
	export GNUPGHOME="${ASDF_DIR:-$HOME/.asdf}/keyrings/nodejs" && mkdir -p "$GNUPGHOME" && chmod 0700 "$GNUPGHOME"
	bash ~/.asdf/plugins/nodejs/bin/import-release-team-keyring
	(cd asdf && (cat .tool-versions | grep nodejs | xargs asdf install))
}

function makeDirs {
	mkdir -p ~/Dev/src
}


getLatestBrew
brewInstall
stowDotfiles
mackupRestore
initFish
installAsdf
initAsdf
asdfInstallNode
makeDirs
